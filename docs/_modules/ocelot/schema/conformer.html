

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ocelot.schema.conformer &mdash; ocelot 0.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ocelot
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_start.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_start.html#schema">schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_start.html#disorder">Disorder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_start.html#bone-config">Bone Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_start.html#backbone-and-sidechain">Backbone and Sidechain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ocelot.html">ocelot package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ocelot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ocelot.schema.conformer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ocelot.schema.conformer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.fileop</span> <span class="kn">import</span> <span class="n">stringkey</span><span class="p">,</span> <span class="n">intkey</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rdkit.Chem</span> <span class="k">as</span> <span class="nn">Chem</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Molecule</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.xyz</span> <span class="kn">import</span> <span class="n">XYZ</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">Descriptors</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdMolAlign</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">squareform</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>

<span class="kn">from</span> <span class="nn">ocelot.routines.conformerparser</span> <span class="kn">import</span> <span class="n">ACParser</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">Fitter</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">alpha_shape</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">angle_btw</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">coord_transform</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">get_proj_point2plane</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">rotate_along_axis</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">rotation_matrix</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.geometry</span> <span class="kn">import</span> <span class="n">unify</span>
<span class="kn">from</span> <span class="nn">ocelot.routines.pbc</span> <span class="kn">import</span> <span class="n">AtomicRadius</span>
<span class="kn">from</span> <span class="nn">ocelot.schema.graph</span> <span class="kn">import</span> <span class="n">BackboneGraph</span>
<span class="kn">from</span> <span class="nn">ocelot.schema.graph</span> <span class="kn">import</span> <span class="n">BasicGraph</span>
<span class="kn">from</span> <span class="nn">ocelot.schema.graph</span> <span class="kn">import</span> <span class="n">FragmentGraph</span>
<span class="kn">from</span> <span class="nn">ocelot.schema.graph</span> <span class="kn">import</span> <span class="n">MolGraph</span>
<span class="kn">from</span> <span class="nn">ocelot.schema.graph</span> <span class="kn">import</span> <span class="n">SidechainGraph</span>
<span class="kn">from</span> <span class="nn">ocelot.schema.rdfunc</span> <span class="kn">import</span> <span class="n">RdFunc</span>

<span class="n">_coordination_rule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;Li&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;Na&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;Be&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;Mg&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;Ca&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;Al&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;Ga&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;Si&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;Ge&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;Sn&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;As&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;Se&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;Cl&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;Br&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="ConformerError"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerError">[docs]</a><span class="k">class</span> <span class="nc">ConformerError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="SiteidError"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SiteidError">[docs]</a><span class="k">class</span> <span class="nc">SiteidError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<span class="n">_rdmol_sani</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">_rdmol_force_single</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_rdmol_charged_fragments</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_rdmol_expliciths</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="SiteidOperation"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SiteidOperation">[docs]</a><span class="k">class</span> <span class="nc">SiteidOperation</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

<div class="viewcode-block" id="SiteidOperation.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SiteidOperation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">:</span> <span class="p">[</span><span class="n">Site</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="n">sites</span></div>

        <span class="c1"># allkeys = [&#39;siteid&#39;]</span>
        <span class="c1"># for s in self.sites:</span>
        <span class="c1">#     allkeys += list(s.properties.keys())</span>
        <span class="c1"># allkeys = list(set(allkeys))</span>
        <span class="c1">#</span>
        <span class="c1"># for i in range(len(self)):</span>
        <span class="c1">#     k = &#39;siteid&#39;</span>
        <span class="c1">#     # for k in allkeys:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         self[i].properties[k]</span>
        <span class="c1">#     except KeyError:</span>
        <span class="c1">#         self[i].properties[k] = None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">siteids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SiteidError</span><span class="p">(</span><span class="s1">&#39;at least one site does not have siteid field!&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="SiteidOperation.get_site_byid"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SiteidOperation.get_site_byid">[docs]</a>    <span class="k">def</span> <span class="nf">get_site_byid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">siteid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param int siteid:</span>
<span class="sd">        :return: (a list of) msite obj</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdict</span><span class="p">[</span><span class="n">siteid</span><span class="p">]</span></div>
        <span class="c1"># if multimatch:</span>
        <span class="c1">#     sites_matches = []</span>
        <span class="c1">#     for s in self:</span>
        <span class="c1">#         if s.properties[&#39;siteid&#39;] == siteid:</span>
        <span class="c1">#             sites_matches.append(s)</span>
        <span class="c1">#     if len(sites_matches) == 0:</span>
        <span class="c1">#         raise SiteidError(&#39;cannot get site by id: {}&#39;.format(siteid))</span>
        <span class="c1">#     return sites_matches</span>
        <span class="c1"># else:</span>
        <span class="c1">#     for s in self:</span>
        <span class="c1">#         if s.properties[&#39;siteid&#39;] == siteid:</span>
        <span class="c1">#             return s</span>

<div class="viewcode-block" id="SiteidOperation.get_sites_byids"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SiteidOperation.get_sites_byids">[docs]</a>    <span class="k">def</span> <span class="nf">get_sites_byids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkstatus</span><span class="p">(</span><span class="s1">&#39;all assigned&#39;</span><span class="p">,</span> <span class="s1">&#39;unique ids&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">siteids</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">SiteidError</span><span class="p">(</span><span class="s1">&#39;siteids is not a subset of sitelist when init conformer&#39;</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">siteids</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># for s in self:</span>
            <span class="c1"># if s.properties[&#39;siteid&#39;] in siteids:</span>
            <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                <span class="n">rs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rs</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check status based on conformer.siteids</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># if self.siteids[0] == 0:</span>
        <span class="c1">#     s.append(&#39;0start&#39;)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     s.append(&#39;not0strat&#39;)</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="kc">None</span><span class="p">}:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;all none&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="kc">None</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;partially none&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;all assigned&#39;</span><span class="p">)</span>

        <span class="c1"># try:</span>
        <span class="c1">#     cri = all(a + 1 == b for a, b in zip(self.siteids, self.siteids[1:]))</span>
        <span class="c1">#     if cri:</span>
        <span class="c1">#         s.append(&#39;continuous&#39;)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         s.append(&#39;not continuous&#39;)</span>
        <span class="c1"># except TypeError:</span>
        <span class="c1">#     pass</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;duplicate ids&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;unique ids&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="SiteidOperation.assign_siteid"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SiteidOperation.assign_siteid">[docs]</a>    <span class="k">def</span> <span class="nf">assign_siteid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">siteids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param siteids: default None means siteid = index, otherwise siteid = siteids[i]</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">siteids</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">siteids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">siteids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">siteids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">siteids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SiteidError</span><span class="p">(</span><span class="s1">&#39;siteids are not legit!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SiteidOperation.checkstatus"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SiteidOperation.checkstatus">[docs]</a>    <span class="k">def</span> <span class="nf">checkstatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SiteidError</span><span class="p">(</span><span class="s1">&#39;no &lt;</span><span class="si">{}</span><span class="s1">&gt; in status!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="BasicConformer"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer">[docs]</a><span class="k">class</span> <span class="nc">BasicConformer</span><span class="p">(</span><span class="n">SiteidOperation</span><span class="p">):</span>

<div class="viewcode-block" id="BasicConformer.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param sites:</span>
<span class="sd">        :param siteids: a list of siteids, siteids[index]=siteid of self[index]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assign_siteid</span><span class="p">(</span><span class="n">siteids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkstatus</span><span class="p">(</span><span class="s1">&#39;all assigned&#39;</span><span class="p">,</span> <span class="s1">&#39;unique ids&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">composition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmgmol</span><span class="o">.</span><span class="n">composition</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># using center should be enough for sites in a mol</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmgmol</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">pmgmol</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="BasicConformer.compare"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get similarity based on rmsd, return inf if two different molecules</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">rdmol1</span><span class="p">,</span> <span class="n">smiles1</span><span class="p">,</span> <span class="n">siteid2atomidx</span><span class="p">,</span> <span class="n">atomidx2siteid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_rdmol</span><span class="p">()</span>
        <span class="n">rdmol2</span><span class="p">,</span> <span class="n">smiles2</span><span class="p">,</span> <span class="n">siteid2atomidx</span><span class="p">,</span> <span class="n">atomidx2siteid</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">to_rdmol</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">smiles1</span> <span class="o">!=</span> <span class="n">smiles2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">rdmol1</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">rdmol1</span><span class="p">)</span>
        <span class="n">rdmol2</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">rdmol2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rdMolAlign</span><span class="o">.</span><span class="n">GetBestRMS</span><span class="p">(</span><span class="n">rdmol1</span><span class="p">,</span> <span class="n">rdmol2</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pmgmol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cart_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span>
        <span class="k">return</span> <span class="n">coords</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index2siteid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">siteid</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">siteid2index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkstatus</span><span class="p">(</span><span class="s1">&#39;all assigned&#39;</span><span class="p">,</span> <span class="s1">&#39;unique ids&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="BasicConformer.get_nbrmap"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.get_nbrmap">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_nbrmap</span><span class="p">(</span><span class="n">bmat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param np.ndarray bmat: bool bond matrix, i is not bonded to itself</span>
<span class="sd">        :return: nbmap[i] is the index list of i&#39;s neighbors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">numsites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bmat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsites</span><span class="p">):</span>
            <span class="n">nbs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsites</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">nbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">ma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbs</span>
        <span class="k">return</span> <span class="n">ma</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nbrmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nbrmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bondmat</span><span class="p">)</span>

<div class="viewcode-block" id="BasicConformer.get_distmat"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.get_distmat">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_distmat</span><span class="p">(</span><span class="n">coordmat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        distanct matrix</span>

<span class="sd">        :param coordmat: coordinates matrix nx3</span>
<span class="sd">        :return: distmat[i][j] is the euclid distance between coordmat[i] and coordmat[j]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">squareform</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">coordmat</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">distmat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">)</span>

<div class="viewcode-block" id="BasicConformer.get_closest_sites"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.get_closest_sites">[docs]</a>    <span class="k">def</span> <span class="nf">get_closest_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        other_sites -- self_border_site --- distmin --- other_border_site -- other_sites</span>

<span class="sd">        this can be used to see if a dimer is interesting or not</span>

<span class="sd">        :param AtomList other:</span>
<span class="sd">        :return: i, j, distmin</span>
<span class="sd">        conformer[i] is self_border_site,</span>
<span class="sd">        conformer[j] is other_border_site,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distmat</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">)</span>
        <span class="n">minid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">distmat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">i_self_border_site</span> <span class="o">=</span> <span class="n">distmat</span><span class="p">[</span><span class="n">minid</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">j_other_border_site</span> <span class="o">=</span> <span class="n">distmat</span><span class="p">[</span><span class="n">minid</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">distmin</span> <span class="o">=</span> <span class="n">distmat</span><span class="p">[</span><span class="n">minid</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">i_self_border_site</span><span class="p">,</span> <span class="n">j_other_border_site</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">i_self_border_site</span><span class="p">],</span> <span class="n">other</span><span class="p">[</span><span class="n">j_other_border_site</span><span class="p">],</span> <span class="n">distmin</span></div>

<div class="viewcode-block" id="BasicConformer.get_site_by_coords"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.get_site_by_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_site_by_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        will only return one site</span>

<span class="sd">        :param coords:</span>
<span class="sd">        :param tol:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BasicConformer.get_bondmat"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.get_bondmat">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_bondmat</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">distmat</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="mf">1.3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bij = whether there is a bond between si and sj, i is NOT bonded with itself</span>

<span class="sd">        if site is not a legit atom (e.g. bq in nics), it cannot have any bond</span>

<span class="sd">        :param sites:</span>
<span class="sd">        :param distmat:</span>
<span class="sd">        :param co: coefficient for cutoff, default 1.3, based on covalent rad</span>
<span class="sd">        :return: bool matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">numsites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">numsites</span><span class="p">,</span> <span class="n">numsites</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsites</span><span class="p">):</span>
            <span class="n">irad</span> <span class="o">=</span> <span class="n">AtomicRadius</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numsites</span><span class="p">):</span>
                <span class="n">jrad</span> <span class="o">=</span> <span class="n">AtomicRadius</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">cutoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">irad</span> <span class="o">+</span> <span class="n">jrad</span><span class="p">)</span> <span class="o">*</span> <span class="n">co</span>
                <span class="k">if</span> <span class="mf">1e-5</span> <span class="o">&lt;</span> <span class="n">distmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">mat</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bondmat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="mf">1.3</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bondmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">distmat</span><span class="p">,</span> <span class="n">co</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">species_string</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geoc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        geometric center</span>

<span class="sd">        :return: 3x1 np array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span>
        <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">volume_slow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boxdensity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        http://wiki.bkslab.org/index.php/Calculate_volume_of_the_binding_site_and_molecules</span>

<span class="sd">        First, Lay a grid over the spheres.</span>

<span class="sd">        Count the number or points contained in the spheres (Ns).</span>

<span class="sd">        Count the number of points in the grid box (Ng).</span>

<span class="sd">        Calculate the volume of the grid box (Vb).</span>

<span class="sd">        don&#39;t use this as it&#39;s slow...</span>

<span class="sd">        :return: volume in A^3</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">covrad</span>

        <span class="n">box_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">mat</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">box_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">mat</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">box_min</span><span class="p">,</span> <span class="n">box_max</span> <span class="o">+</span> <span class="n">boxdensity</span><span class="p">,</span> <span class="n">boxdensity</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ngps_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">ngps_occu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">igp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">iap</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">)):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">igp</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">iap</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">mat</span><span class="p">[</span><span class="n">iap</span><span class="p">][</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="n">ngps_occu</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngps_occu</span> <span class="o">/</span> <span class="n">ngps_total</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">box_max</span> <span class="o">-</span> <span class="n">box_min</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@property</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span> <span class="nf">atomic_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of atomic numbers.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">specie</span><span class="o">.</span><span class="n">Z</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># @property</span>
    <span class="c1"># def atomic_radii(self):</span>
    <span class="c1">#     return (Element(site.species_string).atomic_radius for site in self)</span>
    <span class="c1"># return tuple(atomic_radius Elesite.species_string for site in self)</span>

<div class="viewcode-block" id="BasicConformer.intersection"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.intersection">[docs]</a>    <span class="k">def</span> <span class="nf">intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param other:</span>
<span class="sd">        :param bool copy: whether generate a list of deepcopied sites or not</span>
<span class="sd">        :return: a list of sites in conformer that belong to both</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="BasicConformer.issubset"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.issubset">[docs]</a>    <span class="k">def</span> <span class="nf">issubset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param other:</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other</span><span class="p">))</span></div>

<div class="viewcode-block" id="BasicConformer.sort_by_siteid"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.sort_by_siteid">[docs]</a>    <span class="k">def</span> <span class="nf">sort_by_siteid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkstatus</span><span class="p">(</span><span class="s1">&#39;all assigned&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="BasicConformer.rotate_along"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.rotate_along">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for each site, rotate the vector defined by (site.coords - end1) along (end2 - end1) and add this vector to site.coords</span>

<span class="sd">        end1 - end2</span>
<span class="sd">        |</span>
<span class="sd">        site</span>

<span class="sd">        notice the coords are changed in-place</span>

<span class="sd">        :param theta: angle of rotation</span>
<span class="sd">        :param end1: 3x1 float list/array</span>
<span class="sd">        :param end2: 3x1 float list/array</span>
<span class="sd">        :param str unit: degree/radian</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
        <span class="n">end2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">end1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">end1</span> <span class="o">+</span> <span class="n">rotate_along_axis</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">end2</span> <span class="o">-</span> <span class="n">end1</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">thetaunit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.rotate_along_de_matrix"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.rotate_along_de_matrix">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rotate_along_de_matrix</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">end1</span><span class="p">,</span> <span class="n">end2</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        rotation matrix :func:`~BasicConformer.rotate_along`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
        <span class="n">end2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end2</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">end2</span> <span class="o">-</span> <span class="n">end1</span>
        <span class="k">return</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">thetaunit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.rotate_along_with_matrix"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.rotate_along_with_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_along_with_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">end1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        a quicker version rotate_along if we konw the rotation matrix, end2 is included in the matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">end1</span>
            <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">end1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.orient"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.orient">[docs]</a>    <span class="k">def</span> <span class="nf">orient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pqo</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;geoc&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        p, q, o are 3 orthonormal vectors in x, y, z basis</span>

<span class="sd">        basis transformation from xyz to pqo, notice sites are deepcopied</span>

<span class="sd">        :param pqo: 3x3 array</span>
<span class="sd">        :param origin: default geoc, otherwise a 3d coord</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pqo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pqo</span><span class="p">)</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="n">pqo</span>
        <span class="n">newsites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;geoc&#39;</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoc</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coord_transform</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">origin</span><span class="p">)</span>
            <span class="n">newsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">newsites</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.get_nbrmap_based_on_siteid"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.get_nbrmap_based_on_siteid">[docs]</a>    <span class="k">def</span> <span class="nf">get_nbrmap_based_on_siteid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="mf">1.3</span><span class="p">):</span>
        <span class="n">bmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bondmat_based_on_siteid</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">:</span>
            <span class="n">nbs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">nbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">ma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbs</span>
        <span class="k">return</span> <span class="n">ma</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">can_rdmol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_rdmol</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="BasicConformer.get_bondmat_based_on_siteid"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.get_bondmat_based_on_siteid">[docs]</a>    <span class="k">def</span> <span class="nf">get_bondmat_based_on_siteid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">co</span><span class="o">=</span><span class="mf">1.3</span><span class="p">):</span>
        <span class="c1"># self.checkstatus(&#39;all assigned&#39;, &#39;unique ids&#39;)</span>
        <span class="n">distmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distmat</span>
        <span class="n">siteid_to_disti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">siteid2index</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">:</span>
                <span class="n">mat</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># print(self.siteids)</span>
        <span class="c1"># mat = np.zeros((max(self.siteids) + 10, max(self.siteids) + 10), dtype=bool)</span>
        <span class="k">for</span> <span class="n">isidi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">sidi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">[</span><span class="n">isidi</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">siteid_to_disti</span><span class="p">[</span><span class="n">sidi</span><span class="p">]</span>
            <span class="n">irad</span> <span class="o">=</span> <span class="n">AtomicRadius</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">isidj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">isidi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="n">sidj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">siteids</span><span class="p">[</span><span class="n">isidj</span><span class="p">]</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">siteid_to_disti</span><span class="p">[</span><span class="n">sidj</span><span class="p">]</span>
                <span class="n">jrad</span> <span class="o">=</span> <span class="n">AtomicRadius</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">distmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                <span class="n">cutoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">irad</span> <span class="o">+</span> <span class="n">jrad</span><span class="p">)</span> <span class="o">*</span> <span class="n">co</span>
                <span class="k">if</span> <span class="mf">1e-5</span> <span class="o">&lt;</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">sidi</span><span class="p">][</span><span class="n">sidj</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">mat</span><span class="p">[</span><span class="n">sidj</span><span class="p">][</span><span class="n">sidi</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">mat</span></div>

<div class="viewcode-block" id="BasicConformer.to_graph"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.to_graph">[docs]</a>    <span class="k">def</span> <span class="nf">to_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodename</span><span class="o">=</span><span class="s1">&#39;siteid&#39;</span><span class="p">,</span> <span class="n">graphtype</span><span class="o">=</span><span class="s1">&#39;MolGraph&#39;</span><span class="p">,</span> <span class="n">partition_scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">joints</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get a Graph, default siteid --&gt; nodename</span>

<span class="sd">        otherwise nodename is assigned based on the order in self.sites</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bondmat_by_siteid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bondmat_based_on_siteid</span><span class="p">(</span><span class="n">co</span><span class="o">=</span><span class="mf">1.3</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nodename</span> <span class="o">==</span> <span class="s1">&#39;siteid&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">],</span> <span class="n">symbol</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">species_string</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
                    <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">],</span> <span class="n">symbol</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">species_string</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">bondmat_by_siteid</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]][</span><span class="n">ss</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]]:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">graphtype</span> <span class="o">==</span> <span class="s1">&#39;MolGraph&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MolGraph</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">graphtype</span> <span class="o">==</span> <span class="s1">&#39;FragmentGraph&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FragmentGraph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">joints</span><span class="o">=</span><span class="n">joints</span><span class="p">,</span> <span class="n">partition_scheme</span><span class="o">=</span><span class="n">partition_scheme</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">graphtype</span> <span class="o">==</span> <span class="s1">&#39;BackboneGraph&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BackboneGraph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">joints</span><span class="o">=</span><span class="n">joints</span><span class="p">,</span> <span class="n">partition_scheme</span><span class="o">=</span><span class="n">partition_scheme</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">graphtype</span> <span class="o">==</span> <span class="s1">&#39;SidechainGraph&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SidechainGraph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">joints</span><span class="o">=</span><span class="n">joints</span><span class="p">,</span> <span class="n">partition_scheme</span><span class="o">=</span><span class="n">partition_scheme</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BasicGraph</span><span class="p">(</span><span class="n">g</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.is_missing_hydrogen"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.is_missing_hydrogen">[docs]</a>    <span class="k">def</span> <span class="nf">is_missing_hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rdmol</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">siteid2atomidx</span><span class="p">,</span> <span class="n">atomidx2siteid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_rdmol</span><span class="p">()</span>  <span class="c1"># hydrogens are explicitly added</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;to_rdmol failed for this conformer! we believe it misses hydrogen&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">666</span>
        <span class="c1"># to_rdmol is quite sensitive to AC, if AC is wrong and charged_frag=False then nradical will be quite large</span>
        <span class="n">nradical</span> <span class="o">=</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">NumRadicalElectrons</span><span class="p">(</span><span class="n">rdmol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nradical</span></div>
        <span class="c1"># this will do nothing as to_rdmol specified hydrogens</span>
        <span class="c1"># rdmolh = Chem.AddHs(rdmol)</span>

<div class="viewcode-block" id="BasicConformer.to_rdmol"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.to_rdmol">[docs]</a>    <span class="k">def</span> <span class="nf">to_rdmol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sani</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">charged_fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_single</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expliciths</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generate a rdmol obj with current conformer</span>

<span class="sd">        siteid --dict--&gt; atomidx in rdmol == index in conformer</span>

<span class="sd">        :param charge:</span>
<span class="sd">        :param sani:</span>
<span class="sd">        :param charged_fragments:</span>
<span class="sd">        :param force_single:</span>
<span class="sd">        :param expliciths:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">siteid2atomidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">siteid2index</span>
        <span class="n">atomidx2siteid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index2siteid</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Conformer</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">coordmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cart_coords</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">SetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">coordmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">coordmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">coordmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;joints&#39;</span><span class="p">):</span>  <span class="c1"># LBYL</span>
            <span class="n">apriori_radicals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">apriori_radicals</span><span class="p">[</span><span class="n">siteid2atomidx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">apriori_radicals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondmat</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="n">ACParser</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">,</span> <span class="n">sani</span><span class="o">=</span><span class="n">sani</span><span class="p">,</span> <span class="n">apriori_radicals</span><span class="o">=</span><span class="n">apriori_radicals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">charged_fragments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rdmol</span><span class="p">,</span> <span class="n">smiles</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">charged_fragments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_single</span><span class="o">=</span><span class="n">force_single</span><span class="p">,</span> <span class="n">expliciths</span><span class="o">=</span><span class="n">expliciths</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">AtomValenceException</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;AP parser cannot use radical scheme, trying to use charged frag&#39;</span><span class="p">)</span>
                <span class="n">rdmol</span><span class="p">,</span> <span class="n">smiles</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">charged_fragments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_single</span><span class="o">=</span><span class="n">force_single</span><span class="p">,</span> <span class="n">expliciths</span><span class="o">=</span><span class="n">expliciths</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rdmol</span><span class="p">,</span> <span class="n">smiles</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">charged_fragments</span><span class="o">=</span><span class="n">charged_fragments</span><span class="p">,</span> <span class="n">force_single</span><span class="o">=</span><span class="n">force_single</span><span class="p">,</span> <span class="n">expliciths</span><span class="o">=</span><span class="n">expliciths</span><span class="p">)</span>
        <span class="n">rdmol</span><span class="o">.</span><span class="n">AddConformer</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rdmol</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">siteid2atomidx</span><span class="p">,</span> <span class="n">atomidx2siteid</span></div>

<div class="viewcode-block" id="BasicConformer.to"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.to">[docs]</a>    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmgmol</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.from_sites"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.from_sites">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sites</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        we use this as the parent constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.from_pmgmol"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.from_pmgmol">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pmgmol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.from_siteids"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.from_siteids">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_siteids</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        build up a ring based on a list of siteid and a list of sites</span>

<span class="sd">        the sites should have been assigned siteids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">SiteidOperation</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">get_sites_byids</span><span class="p">(</span><span class="n">siteids</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicConformer.from_file"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_pmgmol</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s1">&#39;conformer built from file, siteids are assigned by the order of entries in file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">c</span></div>

<div class="viewcode-block" id="BasicConformer.from_str"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.from_str">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_str</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_string</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="n">conformer</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_pmgmol</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;conformer built from string, siteids are assigned by the order of entries in the string&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conformer</span></div>

<div class="viewcode-block" id="BasicConformer.as_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;@module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="s2">&quot;@class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;sites&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="BasicConformer.from_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BasicConformer.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">Site</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BondConformer"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BondConformer">[docs]</a><span class="k">class</span> <span class="nc">BondConformer</span><span class="p">(</span><span class="n">BasicConformer</span><span class="p">):</span>

<div class="viewcode-block" id="BondConformer.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BondConformer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span>
        <span class="c1"># self.checkstatus(&#39;all assigned&#39;, &#39;unique ids&#39;)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;only use two sites to create a bond! you are using </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span></div>


<div class="viewcode-block" id="RingConformer"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.RingConformer">[docs]</a><span class="k">class</span> <span class="nc">RingConformer</span><span class="p">(</span><span class="n">BasicConformer</span><span class="p">):</span>
<div class="viewcode-block" id="RingConformer.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.RingConformer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span>
        <span class="c1"># self.checkstatus(&#39;all assigned&#39;, &#39;unique ids&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_member</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_member</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;you are initializing a ring with less than 3 sites!&#39;</span><span class="p">)</span>
        <span class="n">normal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptsmean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pl_error</span> <span class="o">=</span> <span class="n">Fitter</span><span class="o">.</span><span class="n">plane_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="n">normal</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bonds_in_ring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        bond objects can be extracted from this ring</span>
<span class="sd">        e.g. for benzene the C-H bonds are NOT here</span>

<span class="sd">        :return: a list of bonds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondmat</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">ij</span>
            <span class="k">if</span> <span class="n">bmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">BondConformer</span><span class="o">.</span><span class="n">from_sites</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
                    <span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bonds</span>

<div class="viewcode-block" id="RingConformer.normal_along"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.RingConformer.normal_along">[docs]</a>    <span class="k">def</span> <span class="nf">normal_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refnormal</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">45.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the n1 or n2 that is along the direction of refnormal within a certain tol</span>
<span class="sd">        this is useful to identify 2 plane normals for a partially-bent structure</span>

<span class="sd">        :param refnormal: 3x1 array</span>
<span class="sd">        :param float tol: default 45 in degree</span>
<span class="sd">        :return: None if no normal along refnormal found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle_btw</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">refnormal</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">tol</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">n</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;W: no normal along this direction!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="RingConformer.get_avg_norms"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.RingConformer.get_avg_norms">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_avg_norms</span><span class="p">(</span><span class="n">rings</span><span class="p">):</span>
        <span class="n">ref_ring</span> <span class="o">=</span> <span class="n">rings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">avg_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
            <span class="n">normal_along_avenorm</span> <span class="o">=</span> <span class="n">ring</span><span class="o">.</span><span class="n">normal_along</span><span class="p">(</span><span class="n">ref_ring</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normal_along_avenorm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">avg_norm</span> <span class="o">+=</span> <span class="n">ring</span><span class="o">.</span><span class="n">normal_along</span><span class="p">(</span><span class="n">ref_ring</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unify</span><span class="p">(</span><span class="n">avg_norm</span><span class="p">),</span> <span class="o">-</span><span class="n">unify</span><span class="p">(</span><span class="n">avg_norm</span><span class="p">)</span></div>

<div class="viewcode-block" id="RingConformer.iscoplane_with_norm"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.RingConformer.iscoplane_with_norm">[docs]</a>    <span class="k">def</span> <span class="nf">iscoplane_with_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">tolunit</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        whether two rings are on the same plane with tol</span>

<span class="sd">        :param v2:</span>
<span class="sd">        :param tol: degree default 20</span>
<span class="sd">        :param tolunit: degree/radian</span>
<span class="sd">        :return: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tolunit</span> <span class="o">==</span> <span class="s1">&#39;degree&#39;</span><span class="p">:</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">tol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v1</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">]:</span>
            <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">angle_btw</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RingConformer.iscoplane_with"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.RingConformer.iscoplane_with">[docs]</a>    <span class="k">def</span> <span class="nf">iscoplane_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">tolunit</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        whether two rings are on the same plane with tol</span>

<span class="sd">        :param Ring other:</span>
<span class="sd">        :param tol: degree default 20</span>
<span class="sd">        :param tolunit: degree/radian</span>
<span class="sd">        :return: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tolunit</span> <span class="o">==</span> <span class="s1">&#39;degree&#39;</span><span class="p">:</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">tol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v1</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">n1</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n2</span><span class="p">]:</span>
                <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">angle_btw</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RingConformer.as_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.RingConformer.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;n_member&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_member</span>
        <span class="c1"># d[&#39;bonds&#39;] = [b.as_dict() for b in self.bonds_in_ring]</span>
        <span class="k">return</span> <span class="n">d</span></div></div>


<div class="viewcode-block" id="conformer_addh"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.conformer_addh">[docs]</a><span class="k">def</span> <span class="nf">conformer_addh</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">BasicConformer</span><span class="p">,</span> <span class="n">joints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">original</span><span class="p">:</span> <span class="n">BasicConformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    all sites will be deep copied</span>

<span class="sd">    if we know nothing about the joints, we have to find the under-coordinated sites, then terminate them based on # of</span>
<span class="sd">    valence electrons</span>

<span class="sd">    if we know the joints as a list or set of siteids but not the original conformer, we just terminate them based on # of valence electrons</span>

<span class="sd">    if we know the joints as a dict but not the original conformer, we terminate them based on len(joints[siteid])</span>

<span class="sd">    if we know the joints and the orginal conformer, we can terminate them based on # of bonds broken during fragmenting, in this case joints is a dict</span>

<span class="sd">    :param c:</span>
<span class="sd">    :param joints:</span>
<span class="sd">    :param original:</span>
<span class="sd">    :return: d[siteid_of_the_joint] = a list of hydrogen sites</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">joints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;adding h based on undercoordination&#39;</span><span class="p">)</span>
        <span class="n">nbrmap</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nbrmap</span>
        <span class="n">hsites_by_joint_siteid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">hsites</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nvalence</span> <span class="o">=</span> <span class="n">_coordination_rule</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">species_string</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">nvalence</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">nvalence</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>  <span class="c1"># we got a joint</span>
                <span class="n">nh_to_be_added</span> <span class="o">=</span> <span class="n">nvalence</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">nb_idx</span> <span class="ow">in</span> <span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">v_nb_to_s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="n">nb_idx</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span>
                        <span class="n">v_s_to_h</span> <span class="o">+=</span> <span class="n">v_nb_to_s</span>
                    <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">v_s_to_h</span><span class="p">)</span>
                    <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="mf">1.1</span>
                    <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                    <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">nb1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">nb2</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">nb1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">nb2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">unify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nb1</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">nb2</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                            <span class="n">nb2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;currently there are only two possilities&#39;</span><span class="p">)</span>
                    <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nb1</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">nb2</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
                    <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="mf">1.1</span>
                    <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                    <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                    <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.1</span>
                    <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                    <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;currently there are only two possilities&#39;</span><span class="p">)</span>
                <span class="n">hsites_by_joint_siteid</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hsites</span>
                <span class="k">return</span> <span class="n">hsites_by_joint_siteid</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joints</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joints</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;adding h based on undercoordination at joints&#39;</span><span class="p">)</span>
                <span class="n">nbrmap</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nbrmap</span>
                <span class="n">hsites_by_joint_siteid</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joints</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">hsites</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">nvalence</span> <span class="o">=</span> <span class="n">_coordination_rule</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">species_string</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">nvalence</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">nvalence</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>  <span class="c1"># we got a joint</span>
                        <span class="n">nh_to_be_added</span> <span class="o">=</span> <span class="n">nvalence</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">nb_idx</span> <span class="ow">in</span> <span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="n">v_nb_to_s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="n">nb_idx</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span>
                                <span class="n">v_s_to_h</span> <span class="o">+=</span> <span class="n">v_nb_to_s</span>
                            <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">v_s_to_h</span><span class="p">)</span>
                            <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="mf">1.1</span>
                            <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                            <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">nb1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                                <span class="n">nb2</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">nb1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                                <span class="n">nb2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">unify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nb1</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">nb2</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                                    <span class="n">nb2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;currently there are only two possilities&#39;</span><span class="p">)</span>
                            <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nb1</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">nb2</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
                            <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="mf">1.1</span>
                            <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                            <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                            <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.1</span>
                            <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                            <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;currently there are only two possilities&#39;</span><span class="p">)</span>
                        <span class="n">hsites_by_joint_siteid</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hsites</span>
                <span class="k">return</span> <span class="n">hsites_by_joint_siteid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joints</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;adding h based on fragmenting, but coords of H are calculated seperately as we do not know the original molecule&#39;</span><span class="p">)</span>
                <span class="n">hsites_by_joint_siteid</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">nbrmap</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nbrmap</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joints</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="n">hsites</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">nh_to_be_added</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">joints</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">nb_idx</span> <span class="ow">in</span> <span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="n">v_nb_to_s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="n">nb_idx</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span>
                            <span class="n">v_s_to_h</span> <span class="o">+=</span> <span class="n">v_nb_to_s</span>
                        <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">v_s_to_h</span><span class="p">)</span>
                        <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="mf">1.1</span>
                        <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                        <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">nh_to_be_added</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">nb1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">nb2</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">nb1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">nbrmap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">nb2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">unify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nb1</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">nb2</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                                <span class="n">nb2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;currently there are only two possilities&#39;</span><span class="p">)</span>
                        <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nb1</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">nb2</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
                        <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="mf">1.1</span>
                        <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                        <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                        <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.1</span>
                        <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                        <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;currently there are only two possilities&#39;</span><span class="p">)</span>
                    <span class="n">hsites_by_joint_siteid</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hsites</span>
                <span class="k">return</span> <span class="n">hsites_by_joint_siteid</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;adding h based on fragmenting, we know the original molecule&#39;</span><span class="p">)</span>
                <span class="n">hsites_by_joint_siteid</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joints</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="n">hsites</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">joints</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]]:</span>
                        <span class="n">nb_site</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">get_site_byid</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
                        <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">nb_site</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span>
                        <span class="n">v_s_to_h</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">v_s_to_h</span><span class="p">)</span>
                        <span class="n">hcoords</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">v_s_to_h</span> <span class="o">*</span> <span class="mf">1.1</span>
                        <span class="n">hsite</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">hcoords</span><span class="p">)</span>
                        <span class="n">hsites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsite</span><span class="p">)</span>
                    <span class="n">hsites_by_joint_siteid</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;siteid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hsites</span>
                <span class="k">return</span> <span class="n">hsites_by_joint_siteid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joints can be a list, set or a dict!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="conformer_addhmol"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.conformer_addhmol">[docs]</a><span class="k">def</span> <span class="nf">conformer_addhmol</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">BasicConformer</span><span class="p">,</span> <span class="n">joints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">original</span><span class="p">:</span> <span class="n">BasicConformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">hsite_dict</span> <span class="o">=</span> <span class="n">conformer_addh</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">joints</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>

    <span class="n">sites</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>
    <span class="n">sites</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">original_properties</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span>
    <span class="n">original_site_keys</span> <span class="o">=</span> <span class="n">original_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">hydrogen_assign_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;occu&#39;</span><span class="p">,</span> <span class="s1">&#39;disg&#39;</span><span class="p">,</span> <span class="s1">&#39;iasym&#39;</span><span class="p">,</span> <span class="s1">&#39;imol&#39;</span><span class="p">,</span> <span class="s1">&#39;icell&#39;</span><span class="p">]</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;hydrogen site properties </span><span class="si">{}</span><span class="s2"> will be assigned based on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hydrogen_assign_keys</span><span class="p">,</span> <span class="n">original_properties</span><span class="p">))</span>

    <span class="n">hsites_to_be_added</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hsite_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">hsites_to_be_added</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">ihs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hsites_to_be_added</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">original_site_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hydrogen_assign_keys</span><span class="p">:</span>
                <span class="n">hsites_to_be_added</span><span class="p">[</span><span class="n">ihs</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;siteid&#39;</span><span class="p">:</span>
                <span class="n">hsites_to_be_added</span><span class="p">[</span><span class="n">ihs</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ihs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span>
                <span class="n">hsites_to_be_added</span><span class="p">[</span><span class="n">ihs</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;addedh&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hsites_to_be_added</span><span class="p">[</span><span class="n">ihs</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;addh_null&#39;</span>
    <span class="n">sites</span> <span class="o">+=</span> <span class="n">hsites_to_be_added</span>
    <span class="k">return</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">SiteidOperation</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span></div>


<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>


<div class="viewcode-block" id="FragConformer"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer">[docs]</a><span class="k">class</span> <span class="nc">FragConformer</span><span class="p">(</span><span class="n">BasicConformer</span><span class="p">):</span>
    <span class="n">_conformer_properties</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="FragConformer.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span>
            <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">conformer_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">graph</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FragmentGraph</span><span class="p">,</span> <span class="n">BackboneGraph</span><span class="p">,</span> <span class="n">SidechainGraph</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conformer_properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span> <span class="o">=</span> <span class="n">conformer_properties</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">FragmentGraph</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;Missing FragmentGraph!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">joints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rings</span><span class="p">()</span></div>

<div class="viewcode-block" id="FragConformer.get_rings"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer.get_rings">[docs]</a>    <span class="k">def</span> <span class="nf">get_rings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rings</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">minimum_cycle_basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>  <span class="c1"># technically sssr</span>
        <span class="n">rings</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">rcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
            <span class="n">ring</span> <span class="o">=</span> <span class="n">RingConformer</span><span class="o">.</span><span class="n">from_siteids</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rcs</span></div>

<div class="viewcode-block" id="FragConformer.calculate_conformer_properties"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer.calculate_conformer_properties">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_conformer_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="FragConformer.from_sites"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer.from_sites">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sites</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">BasicConformer</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">to_graph</span><span class="p">(</span><span class="s1">&#39;siteid&#39;</span><span class="p">,</span> <span class="s1">&#39;FragmentGraph&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span></div>

<div class="viewcode-block" id="FragConformer.from_siteids"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer.from_siteids">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_siteids</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="p">):</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">SiteidOperation</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">get_sites_byids</span><span class="p">(</span><span class="n">siteids</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="n">conformer_properties</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">)</span></div>

<div class="viewcode-block" id="FragConformer.from_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">FragmentGraph</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;conformer_properties&#39;</span><span class="p">]</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">Site</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="n">prop</span><span class="p">)</span></div>

<div class="viewcode-block" id="FragConformer.as_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;conformer_properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="FragConformer.from_pmgmol"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.FragConformer.from_pmgmol">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pmgmol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BoneConformer"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BoneConformer">[docs]</a><span class="k">class</span> <span class="nc">BoneConformer</span><span class="p">(</span><span class="n">FragConformer</span><span class="p">):</span>
    <span class="n">_bone_conformer_properties</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;pfit_vo&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;pfit_vp&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;pfit_vq&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;lfiterror&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;pfiterror&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="BoneConformer.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BoneConformer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span>
            <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">conformer_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">graph</span><span class="p">:</span> <span class="n">BackboneGraph</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">conformer_properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conformer_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bone_conformer_properties</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
        <span class="c1"># self.checkstatus(&#39;all assigned&#39;, &#39;unique ids&#39;)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bone_conformer_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_conformer_properties</span><span class="p">()</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfit_vo</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;pfit_vo&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfit_vp</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;pfit_vp&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfit_vq</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;pfit_vq&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lfit_error</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;lfit_error&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfit_error</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;pfit_error&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lfit_ptsmean</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;lfit_ptsmean&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfit_ptsmean</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;pfit_ptsmean&#39;</span><span class="p">]</span></div>
            <span class="c1"># for k, v in self.conformer_properties.items():</span>
            <span class="c1">#     self.__setattr__(k, v)</span>

<div class="viewcode-block" id="BoneConformer.calculate_conformer_properties"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BoneConformer.calculate_conformer_properties">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_conformer_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;W: you are init backbone with one or no ring! fitting params will be set to defaults&#39;</span><span class="p">)</span>
            <span class="n">site_to_geoc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoc</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">lfit_vp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">site_to_geoc</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lfit_vp</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">lfit_vp</span><span class="p">)</span>
            <span class="n">lfit_error</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lfit_ptsmean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lfit_vp</span><span class="p">,</span> <span class="n">lfit_ptsmean</span><span class="p">,</span> <span class="n">lfit_error</span> <span class="o">=</span> <span class="n">Fitter</span><span class="o">.</span><span class="n">linear_fit</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">geoc</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">])</span>
            <span class="n">lfit_vp</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">lfit_vp</span><span class="p">)</span>
        <span class="c1"># this is the plane fit, vp taken from the projection of lfit_vp</span>
        <span class="c1"># the fitted plane is now used as a cart coord sys with origin at ptsmean</span>
        <span class="n">pfit_vo</span><span class="p">,</span> <span class="n">pfit_ptsmean</span><span class="p">,</span> <span class="n">pfit_error</span> <span class="o">=</span> <span class="n">Fitter</span><span class="o">.</span><span class="n">plane_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">)</span>
        <span class="n">pfit_vp</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">get_proj_point2plane</span><span class="p">(</span><span class="n">pfit_ptsmean</span> <span class="o">+</span> <span class="n">lfit_vp</span><span class="p">,</span> <span class="n">pfit_vo</span><span class="p">,</span> <span class="n">pfit_ptsmean</span><span class="p">)</span> <span class="o">-</span> <span class="n">pfit_ptsmean</span><span class="p">)</span>
        <span class="n">pfit_vq</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">pfit_vo</span><span class="p">,</span> <span class="n">pfit_vp</span><span class="p">))</span>
        <span class="c1"># pfit_plane_params = get_plane_param(pfit_vo, pfit_ptsmean)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pfit_vo&#39;</span><span class="p">:</span> <span class="n">pfit_vo</span><span class="p">,</span>
            <span class="s1">&#39;pfit_vp&#39;</span><span class="p">:</span> <span class="n">pfit_vp</span><span class="p">,</span>
            <span class="s1">&#39;pfit_vq&#39;</span><span class="p">:</span> <span class="n">pfit_vq</span><span class="p">,</span>
            <span class="s1">&#39;lfit_error&#39;</span><span class="p">:</span> <span class="n">lfit_error</span><span class="p">,</span>
            <span class="s1">&#39;pfit_error&#39;</span><span class="p">:</span> <span class="n">pfit_error</span><span class="p">,</span>
            <span class="s1">&#39;lfit_ptsmean&#39;</span><span class="p">:</span> <span class="n">lfit_ptsmean</span><span class="p">,</span>
            <span class="s1">&#39;pfit_ptsmean&#39;</span><span class="p">:</span> <span class="n">pfit_ptsmean</span>
        <span class="p">}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        maxdiff( (s.coord - ref) proj at vq )</span>

<span class="sd">        :return: long axis length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geoc</span>
        <span class="n">projs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_vo</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">projs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">projs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        maxdiff( (s.coord - ref) proj at vp )</span>

<span class="sd">        :return: short axis length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geoc</span>
        <span class="n">projs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_vo</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">projs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">projs</span><span class="p">)</span>

<div class="viewcode-block" id="BoneConformer.from_sites"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BoneConformer.from_sites">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sites</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">BasicConformer</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">to_graph</span><span class="p">(</span><span class="s1">&#39;siteid&#39;</span><span class="p">,</span> <span class="s1">&#39;BackboneGraph&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span></div>

<div class="viewcode-block" id="BoneConformer.from_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.BoneConformer.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">BackboneGraph</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;conformer_properties&#39;</span><span class="p">]</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">Site</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="n">prop</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SidechainConformer"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SidechainConformer">[docs]</a><span class="k">class</span> <span class="nc">SidechainConformer</span><span class="p">(</span><span class="n">FragConformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this can be considered as a special backbone with just one joint</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_sidechain_conformer_properties</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="SidechainConformer.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SidechainConformer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span>
            <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">conformer_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">graph</span><span class="p">:</span> <span class="n">SidechainGraph</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conformer_properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sidechain_conformer_properties</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;sidechain init with no or &gt;1 joints&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sidechain_joint_siteid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joints</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sidechain_joint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_site_byid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sidechain_joint_siteid</span><span class="p">)</span></div>

<div class="viewcode-block" id="SidechainConformer.from_sites"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SidechainConformer.from_sites">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sites</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">BasicConformer</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">to_graph</span><span class="p">(</span><span class="s1">&#39;siteid&#39;</span><span class="p">,</span> <span class="s1">&#39;SidechainGraph&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span></div>

<div class="viewcode-block" id="SidechainConformer.from_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.SidechainConformer.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">SidechainGraph</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;conformer_properties&#39;</span><span class="p">]</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">Site</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conformer_properties</span><span class="o">=</span><span class="n">prop</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="MolConformer"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer">[docs]</a><span class="k">class</span> <span class="nc">MolConformer</span><span class="p">(</span><span class="n">BasicConformer</span><span class="p">):</span>
    <span class="n">rings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RingConformer</span><span class="p">]</span>
    <span class="n">_mol_conformer_properties</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># &#39;smiles&#39;: None,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="MolConformer.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sites</span><span class="p">,</span>
            <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">prop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">graph</span><span class="p">:</span> <span class="n">MolGraph</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">rdmol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">siteid2atomidx</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">atomidx2siteid</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">backbone</span><span class="p">:</span> <span class="n">BoneConformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">sccs</span><span class="p">:</span> <span class="p">[</span><span class="n">SidechainConformer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">backbone_graph</span><span class="p">:</span> <span class="n">BackboneGraph</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">scgs</span><span class="p">:</span> <span class="p">[</span><span class="n">SidechainGraph</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">coplane_cutoff</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
            <span class="n">chrombone</span><span class="p">:</span> <span class="n">FragConformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">chromsccs</span><span class="p">:</span> <span class="p">[</span><span class="n">FragConformer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">chrombone_graph</span><span class="p">:</span> <span class="n">FragmentGraph</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">chromscgs</span><span class="p">:</span> <span class="p">[</span><span class="n">FragmentGraph</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span>
        <span class="c1"># self.checkstatus(&#39;all assigned&#39;, &#39;unique ids&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rdmol</span> <span class="o">=</span> <span class="n">rdmol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">siteid2atomidx</span> <span class="o">=</span> <span class="n">siteid2atomidx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomidx2siteid</span> <span class="o">=</span> <span class="n">atomidx2siteid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">rings</span><span class="p">:</span>
            <span class="n">ring</span> <span class="o">=</span> <span class="n">RingConformer</span><span class="o">.</span><span class="n">from_siteids</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_solvent</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_solvent</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">backbone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backbone_graph</span> <span class="o">=</span> <span class="n">backbone_graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sccs</span> <span class="o">=</span> <span class="n">sccs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scgs</span> <span class="o">=</span> <span class="n">scgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chrombone</span> <span class="o">=</span> <span class="n">chrombone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromsccs</span> <span class="o">=</span> <span class="n">chromsccs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chrombone_graph</span> <span class="o">=</span> <span class="n">chrombone_graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chromscgs</span> <span class="o">=</span> <span class="n">chromscgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coplane_cutoff</span> <span class="o">=</span> <span class="n">coplane_cutoff</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_conformer_properties</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span> <span class="o">=</span> <span class="n">prop</span></div>

<div class="viewcode-block" id="MolConformer.as_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;rdmol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RdFunc</span><span class="o">.</span><span class="n">mol_as_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rdmol</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;siteid2atomidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stringkey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">siteid2atomidx</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;atomidx2siteid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stringkey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomidx2siteid</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;rings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coplane_cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coplane_cutoff</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;conformer_properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;backbone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;backbone_graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_graph</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sccs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sccs</span><span class="p">]</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;scgs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sg</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scgs</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;backbone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;backbone_graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sccs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;scgs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chrombone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrombone</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chrombone_graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrombone_graph</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chromsccs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromsccs</span><span class="p">]</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chromscgs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sg</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromscgs</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chrombone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chrombone_graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chromsccs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chromscgs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;conformer_properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_properties</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="MolConformer.from_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">Site</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sites&#39;</span><span class="p">]]</span>
        <span class="n">siteids</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;conformer_properties&#39;</span><span class="p">]</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">MolGraph</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span>
        <span class="n">rdmol</span> <span class="o">=</span> <span class="n">RdFunc</span><span class="o">.</span><span class="n">mol_from_json</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;rdmol&#39;</span><span class="p">])</span>
        <span class="n">smiles</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span>
        <span class="n">siteid2atomidx</span> <span class="o">=</span> <span class="n">intkey</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;siteid2atomidx&#39;</span><span class="p">])</span>
        <span class="n">atomidx2siteid</span> <span class="o">=</span> <span class="n">intkey</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;atomidx2siteid&#39;</span><span class="p">])</span>
        <span class="n">coplane_cutoff</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coplane_cutoff&#39;</span><span class="p">]</span>
        <span class="n">backbone</span> <span class="o">=</span> <span class="n">BoneConformer</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;backbone&#39;</span><span class="p">])</span>
        <span class="n">sccs</span> <span class="o">=</span> <span class="p">[</span><span class="n">SidechainConformer</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">scd</span><span class="p">)</span> <span class="k">for</span> <span class="n">scd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sccs&#39;</span><span class="p">]]</span>
        <span class="n">backbone_graph</span> <span class="o">=</span> <span class="n">BackboneGraph</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;backbone_graph&#39;</span><span class="p">])</span>
        <span class="n">scgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">SidechainGraph</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">scd</span><span class="p">)</span> <span class="k">for</span> <span class="n">scd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;scgs&#39;</span><span class="p">]]</span>
        <span class="n">chrombone</span> <span class="o">=</span> <span class="n">FragConformer</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;chrombone&#39;</span><span class="p">])</span>
        <span class="n">chromsccs</span> <span class="o">=</span> <span class="p">[</span><span class="n">FragConformer</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sccs&#39;</span><span class="p">]]</span>
        <span class="n">chrombone_graph</span> <span class="o">=</span> <span class="n">FragmentGraph</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;chrombone_graph&#39;</span><span class="p">])</span>
        <span class="n">chromscgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">FragmentGraph</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fg</span><span class="p">)</span> <span class="k">for</span> <span class="n">fg</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;chromscgs&#39;</span><span class="p">]]</span>

        <span class="n">mc</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">sites</span><span class="p">,</span>
            <span class="n">siteids</span><span class="p">,</span>
            <span class="n">prop</span><span class="p">,</span>
            <span class="n">graph</span><span class="p">,</span>
            <span class="n">rdmol</span><span class="p">,</span>
            <span class="n">smiles</span><span class="p">,</span>
            <span class="n">siteid2atomidx</span><span class="p">,</span>
            <span class="n">atomidx2siteid</span><span class="p">,</span>
            <span class="n">backbone</span><span class="p">,</span>
            <span class="n">sccs</span><span class="p">,</span>
            <span class="n">backbone_graph</span><span class="p">,</span>
            <span class="n">scgs</span><span class="p">,</span>
            <span class="n">coplane_cutoff</span><span class="p">,</span>
            <span class="n">chrombone</span><span class="p">,</span>
            <span class="n">chromsccs</span><span class="p">,</span>
            <span class="n">chrombone_graph</span><span class="p">,</span>
            <span class="n">chromscgs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mc</span></div>

<div class="viewcode-block" id="MolConformer.calculate_conformer_properties"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer.calculate_conformer_properties">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_conformer_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="MolConformer.chrom_partition"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer.chrom_partition">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">chrom_partition</span><span class="p">(</span><span class="n">mc</span><span class="p">:</span> <span class="n">BasicConformer</span><span class="p">,</span> <span class="n">rdmol</span><span class="p">,</span> <span class="n">atomidx2siteid</span><span class="p">,</span> <span class="n">molgraph</span><span class="p">:</span> <span class="n">MolGraph</span><span class="p">,</span> <span class="n">withhalogen</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">withhalogen</span><span class="p">:</span>
            <span class="n">cgs</span> <span class="o">=</span> <span class="n">RdFunc</span><span class="o">.</span><span class="n">get_conjugate_group</span><span class="p">(</span><span class="n">rdmol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cgs</span> <span class="o">=</span> <span class="n">RdFunc</span><span class="o">.</span><span class="n">get_conjugate_group_with_halogen</span><span class="p">(</span><span class="n">rdmol</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chromol</span><span class="p">,</span> <span class="n">aid_to_newid_chromol</span> <span class="o">=</span> <span class="n">cgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;rdkit cannot find a chrom here!&#39;</span><span class="p">)</span>
        <span class="n">aids_in_chromol</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aid_to_newid_chromol</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">siteids_in_chromol</span> <span class="o">=</span> <span class="p">[</span><span class="n">atomidx2siteid</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">aids_in_chromol</span><span class="p">]</span>
        <span class="n">chromol_joints</span><span class="p">,</span> <span class="n">other_joints</span><span class="p">,</span> <span class="n">chromolsg</span><span class="p">,</span> <span class="n">sg_components</span> <span class="o">=</span> <span class="n">MolGraph</span><span class="o">.</span><span class="n">get_joints_and_subgraph</span><span class="p">(</span>
            <span class="n">siteids_in_chromol</span><span class="p">,</span> <span class="n">molgraph</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
        <span class="n">cg</span><span class="p">,</span> <span class="n">fgs</span> <span class="o">=</span> <span class="n">MolGraph</span><span class="o">.</span><span class="n">get_chrom_and_frags_from_nxgraph</span><span class="p">(</span><span class="n">chromolsg</span><span class="p">,</span> <span class="n">sg_components</span><span class="p">)</span>
        <span class="n">chromolc</span> <span class="o">=</span> <span class="n">FragConformer</span><span class="o">.</span><span class="n">from_siteids</span><span class="p">(</span>
            <span class="n">siteids_in_chromol</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">cg</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>  <span class="c1"># you need to make sure there is at least a ring here</span>
        <span class="n">fragcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fg</span> <span class="ow">in</span> <span class="n">fgs</span><span class="p">:</span>
            <span class="n">fragc</span> <span class="o">=</span> <span class="n">FragConformer</span><span class="o">.</span><span class="n">from_siteids</span><span class="p">(</span><span class="n">fg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">fg</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">fragcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chromolc</span><span class="p">,</span> <span class="n">fragcs</span><span class="p">,</span> <span class="n">cg</span><span class="p">,</span> <span class="n">fgs</span></div>

<div class="viewcode-block" id="MolConformer.geo_partition"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer.geo_partition">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">geo_partition</span><span class="p">(</span><span class="n">bc</span><span class="p">:</span> <span class="n">BasicConformer</span><span class="p">,</span> <span class="n">molgraph</span><span class="p">:</span> <span class="n">MolGraph</span><span class="p">,</span> <span class="n">coplane_cutoff</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lgfr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">molgraph</span><span class="o">.</span><span class="n">lgfr</span><span class="p">:</span>
                <span class="n">ring</span> <span class="o">=</span> <span class="n">RingConformer</span><span class="o">.</span><span class="n">from_siteids</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">lgfr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;cannot get lgfr!&#39;</span><span class="p">)</span>
        <span class="n">avgn1</span><span class="p">,</span> <span class="n">avgn2</span> <span class="o">=</span> <span class="n">RingConformer</span><span class="o">.</span><span class="n">get_avg_norms</span><span class="p">(</span><span class="n">lgfr</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">coplane_check</span><span class="p">(</span><span class="n">ring_siteids</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">coplane_cutoff</span><span class="p">):</span>
            <span class="n">ringconformer</span> <span class="o">=</span> <span class="n">RingConformer</span><span class="o">.</span><span class="n">from_siteids</span><span class="p">(</span><span class="n">ring_siteids</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">coplane</span> <span class="o">=</span> <span class="n">ringconformer</span><span class="o">.</span><span class="n">iscoplane_with_norm</span><span class="p">(</span><span class="n">avgn1</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="s1">&#39;degree&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">coplane</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bg</span><span class="p">,</span> <span class="n">scgs</span> <span class="o">=</span> <span class="n">molgraph</span><span class="o">.</span><span class="n">partition_to_bone_frags</span><span class="p">(</span><span class="s1">&#39;lgcr&#39;</span><span class="p">,</span> <span class="n">additional_criteria</span><span class="o">=</span><span class="n">coplane_check</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;cannot lgcr partition with coplane_cutoff: </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coplane_cutoff</span><span class="p">))</span>

        <span class="n">bone_conformer</span> <span class="o">=</span> <span class="n">BoneConformer</span><span class="o">.</span><span class="n">from_siteids</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">bg</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">sccs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scg</span> <span class="ow">in</span> <span class="n">scgs</span><span class="p">:</span>
            <span class="n">sc_joint_site_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;joints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bc_joint_site_id</span> <span class="o">=</span> <span class="n">scg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;joints&#39;</span><span class="p">][</span><span class="n">sc_joint_site_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bc_joint_site</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_site_byid</span><span class="p">(</span><span class="n">bc_joint_site_id</span><span class="p">)</span>
            <span class="c1"># print(bc_joint_site)</span>
            <span class="n">v_sc_position</span> <span class="o">=</span> <span class="n">bc_joint_site</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">bc</span><span class="o">.</span><span class="n">geoc</span>
            <span class="n">sc_position_angle</span> <span class="o">=</span> <span class="n">angle_btw</span><span class="p">(</span><span class="n">v_sc_position</span><span class="p">,</span> <span class="n">bone_conformer</span><span class="o">.</span><span class="n">pfit_vp</span><span class="p">,</span> <span class="s1">&#39;degree&#39;</span><span class="p">)</span>
            <span class="n">scc</span> <span class="o">=</span> <span class="n">SidechainConformer</span><span class="o">.</span><span class="n">from_siteids</span><span class="p">(</span><span class="n">scg</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">scg</span><span class="p">,</span>
                                                  <span class="n">conformer_properties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sc_position_angle&#39;</span><span class="p">:</span> <span class="n">sc_position_angle</span><span class="p">,</span>
                                                                        <span class="s1">&#39;bc_joint_siteid&#39;</span><span class="p">:</span> <span class="n">bc_joint_site_id</span><span class="p">})</span>
            <span class="n">sccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bone_conformer</span><span class="p">,</span> <span class="n">sccs</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">scgs</span>  <span class="c1"># sccs &lt;--&gt; scgs bijection</span></div>

<div class="viewcode-block" id="MolConformer.from_sites"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer.from_sites">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sites</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coplane_cutoff</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">withhalogen</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">BasicConformer</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">siteids</span><span class="p">)</span>
        <span class="n">rdmol</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">siteid2atomidx</span><span class="p">,</span> <span class="n">atomidx2siteid</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">to_rdmol</span><span class="p">()</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">to_graph</span><span class="p">(</span><span class="s1">&#39;siteid&#39;</span><span class="p">,</span> <span class="s1">&#39;MolGraph&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">backbone</span><span class="p">,</span> <span class="n">sccs</span><span class="p">,</span> <span class="n">backbone_graph</span><span class="p">,</span> <span class="n">scgs</span> <span class="o">=</span> <span class="n">MolConformer</span><span class="o">.</span><span class="n">geo_partition</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">coplane_cutoff</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConformerError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;geo_partition failed!&#39;</span><span class="p">)</span>
            <span class="n">backbone</span><span class="p">,</span> <span class="n">sccs</span><span class="p">,</span> <span class="n">backbone_graph</span><span class="p">,</span> <span class="n">scgs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chrombone</span><span class="p">,</span> <span class="n">chromsccs</span><span class="p">,</span> <span class="n">chrombone_graph</span><span class="p">,</span> <span class="n">chromscgs</span> <span class="o">=</span> <span class="n">MolConformer</span><span class="o">.</span><span class="n">chrom_partition</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">rdmol</span><span class="p">,</span> <span class="n">atomidx2siteid</span><span class="p">,</span>
                                                                                            <span class="n">graph</span><span class="p">,</span> <span class="n">withhalogen</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConformerError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;chrom_partition failed!&#39;</span><span class="p">)</span>
            <span class="n">chrombone</span><span class="p">,</span> <span class="n">chromsccs</span><span class="p">,</span> <span class="n">chrombone_graph</span><span class="p">,</span> <span class="n">chromscgs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">mc</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">bc</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span>
            <span class="n">siteids</span><span class="p">,</span>
            <span class="n">prop</span><span class="p">,</span>
            <span class="n">graph</span><span class="p">,</span>
            <span class="n">rdmol</span><span class="p">,</span>
            <span class="n">smiles</span><span class="p">,</span>
            <span class="n">siteid2atomidx</span><span class="p">,</span>
            <span class="n">atomidx2siteid</span><span class="p">,</span>
            <span class="n">backbone</span><span class="p">,</span>
            <span class="n">sccs</span><span class="p">,</span>
            <span class="n">backbone_graph</span><span class="p">,</span>
            <span class="n">scgs</span><span class="p">,</span>
            <span class="n">coplane_cutoff</span><span class="p">,</span>
            <span class="n">chrombone</span><span class="p">,</span>
            <span class="n">chromsccs</span><span class="p">,</span>
            <span class="n">chrombone_graph</span><span class="p">,</span>
            <span class="n">chromscgs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mc</span></div>

<div class="viewcode-block" id="MolConformer.to_addhmol"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.MolConformer.to_addhmol">[docs]</a>    <span class="k">def</span> <span class="nf">to_addhmol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bonescheme</span><span class="o">=</span><span class="s1">&#39;geo&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add h and return pmg mol</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bonescheme</span> <span class="o">==</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span>
            <span class="n">backbone_hmol</span> <span class="o">=</span> <span class="n">conformer_addhmol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">joints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone_graph</span><span class="o">.</span><span class="n">joints</span><span class="p">,</span> <span class="n">original</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">sccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sccs</span>
            <span class="n">scgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scgs</span>
        <span class="k">elif</span> <span class="n">bonescheme</span> <span class="o">==</span> <span class="s1">&#39;chrom&#39;</span><span class="p">:</span>
            <span class="n">backbone_hmol</span> <span class="o">=</span> <span class="n">conformer_addhmol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chrombone</span><span class="p">,</span> <span class="n">joints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chrombone_graph</span><span class="o">.</span><span class="n">joints</span><span class="p">,</span> <span class="n">original</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">sccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromsccs</span>
            <span class="n">scgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chromscgs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;addh for </span><span class="si">{}</span><span class="s1"> not implemented&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bonescheme</span><span class="p">))</span>

        <span class="n">schmols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sccs</span><span class="p">)):</span>
            <span class="n">scc</span> <span class="o">=</span> <span class="n">sccs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">scg</span> <span class="o">=</span> <span class="n">scgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">scch</span> <span class="o">=</span> <span class="n">conformer_addhmol</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">scg</span><span class="o">.</span><span class="n">joints</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">schmols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backbone_hmol</span><span class="p">,</span> <span class="n">schmols</span></div></div>


<div class="viewcode-block" id="ConformerDimer"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer">[docs]</a><span class="k">class</span> <span class="nc">ConformerDimer</span><span class="p">:</span>

<div class="viewcode-block" id="ConformerDimer.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conformer_ref</span><span class="p">:</span> <span class="n">MolConformer</span><span class="p">,</span> <span class="n">conformer_var</span><span class="p">:</span> <span class="n">MolConformer</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        basically 2 conformers</span>

<span class="sd">        :param conformer_ref:</span>
<span class="sd">        :param conformer_var:</span>
<span class="sd">        :param str label: mainly used to distinguish</span>

<span class="sd">        Attributes:</span>
<span class="sd">            vslip: slip vector in cart</span>
<span class="sd">            vslipnorm: normalized vslip</span>
<span class="sd">            pslip: projection of vslip along vp</span>
<span class="sd">            qslip: projection of vslip along vq</span>
<span class="sd">            oslip: projection of vslip along vo</span>
<span class="sd">            pangle: angle btw vps</span>
<span class="sd">            qangle: angle btw vps</span>
<span class="sd">            oangle: angle btw vps, always acute</span>
<span class="sd">            jmol: jmol draw arrow string in console</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span> <span class="o">=</span> <span class="n">conformer_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span> <span class="o">=</span> <span class="n">conformer_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

        <span class="n">ref_bone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span>
        <span class="n">var_bone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">backbone</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vslip</span> <span class="o">=</span> <span class="n">var_bone</span><span class="o">.</span><span class="n">geoc</span> <span class="o">-</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">geoc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vslipnorm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vslip</span><span class="p">)</span>
        <span class="n">ref_vp_fit</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vp&#39;</span><span class="p">]</span>
        <span class="n">ref_vq_fit</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vq&#39;</span><span class="p">]</span>
        <span class="n">ref_vo_fit</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vo&#39;</span><span class="p">]</span>
        <span class="n">var_vp_fit</span> <span class="o">=</span> <span class="n">var_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vp&#39;</span><span class="p">]</span>
        <span class="n">var_vq_fit</span> <span class="o">=</span> <span class="n">var_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vq&#39;</span><span class="p">]</span>
        <span class="n">var_vo_fit</span> <span class="o">=</span> <span class="n">var_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vo&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pslip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vslip</span> <span class="o">@</span> <span class="n">ref_vp_fit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qslip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vslip</span> <span class="o">@</span> <span class="n">ref_vq_fit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oslip</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vslip</span> <span class="o">@</span> <span class="n">ref_vo_fit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pangle</span> <span class="o">=</span> <span class="n">angle_btw</span><span class="p">(</span><span class="n">ref_vp_fit</span><span class="p">,</span> <span class="n">var_vp_fit</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qangle</span> <span class="o">=</span> <span class="n">angle_btw</span><span class="p">(</span><span class="n">ref_vq_fit</span><span class="p">,</span> <span class="n">var_vq_fit</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oangle</span> <span class="o">=</span> <span class="n">angle_btw</span><span class="p">(</span><span class="n">ref_vo_fit</span><span class="p">,</span> <span class="n">var_vo_fit</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oangle</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oangle</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">oangle</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jmol</span> <span class="o">=</span> <span class="s2">&quot;draw arrow {{ </span><span class="si">{:.4f}</span><span class="s2">, </span><span class="si">{:.4f}</span><span class="s2">, </span><span class="si">{:.4f}</span><span class="s2"> }} {{ </span><span class="si">{:.4f}</span><span class="s2">, </span><span class="si">{:.4f}</span><span class="s2">, </span><span class="si">{:.4f}</span><span class="s2"> }}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">ref_bone</span><span class="o">.</span><span class="n">geoc</span><span class="p">,</span>
                                                                                                  <span class="o">*</span><span class="n">var_bone</span><span class="o">.</span><span class="n">geoc</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConformerDimer.as_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        keys are</span>

<span class="sd">        vslipnorm, pslip, qslip, oslip, pangle, qangle, oangle, jmol, label, omol_ref, omol_var</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;@module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="s2">&quot;@class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;vslipnorm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vslipnorm</span><span class="p">,</span>
             <span class="s1">&#39;pslip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pslip</span><span class="p">,</span> <span class="s1">&#39;qslip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qslip</span><span class="p">,</span> <span class="s1">&#39;oslip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oslip</span><span class="p">,</span> <span class="s1">&#39;pangle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pangle</span><span class="p">,</span>
             <span class="s1">&#39;qangle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qangle</span><span class="p">,</span> <span class="s1">&#39;oangle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oangle</span><span class="p">,</span> <span class="s1">&#39;jmol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jmol</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
             <span class="s1">&#39;ref&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span> <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="ConformerDimer.from_dict"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        keys are</span>

<span class="sd">        omol_ref, omol_var, label</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">MolConformer</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">])</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">MolConformer</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConformerDimer.to_xyz"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer.to_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">to_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">center_label</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">sites</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">sites</span>
        <span class="k">if</span> <span class="n">center_label</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Site</span><span class="p">(</span><span class="s1">&#39;La&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">geoc</span><span class="p">)]</span>
            <span class="n">sites</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Site</span><span class="p">(</span><span class="s1">&#39;La&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">geoc</span><span class="p">)]</span>
        <span class="n">Molecule</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConformerDimer.to_xyzstring"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer.to_xyzstring">[docs]</a>    <span class="k">def</span> <span class="nf">to_xyzstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center_label</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">sites</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">sites</span>
        <span class="k">if</span> <span class="n">center_label</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Site</span><span class="p">(</span><span class="s1">&#39;La&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">geoc</span><span class="p">)]</span>
            <span class="n">sites</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Site</span><span class="p">(</span><span class="s1">&#39;La&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">geoc</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">XYZ</span><span class="p">(</span><span class="n">Molecule</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">)))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_identical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        whether two omols are identical, based on norm(vslip) &lt; 1e-5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vslip</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_not_identical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_identical</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_bone_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">6.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        use to identify whether this dimer can have minimum wf overlap, ONLY consider bone distance</span>

<span class="sd">        this should be called is_not_faraway...</span>

<span class="sd">        :param cutoff: minbonedist less than which will be considered close</span>
<span class="sd">        :return: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">minbonedist</span> <span class="o">&lt;</span> <span class="n">cutoff</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">6.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        use to identify whether this dimer can have minimum wf overlap</span>

<span class="sd">        this should be called is_not_faraway...</span>

<span class="sd">        :param cutoff:</span>
<span class="sd">        :return: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mindist</span> <span class="o">&lt;</span> <span class="n">cutoff</span>

    <span class="c1"># @property</span>
    <span class="c1"># def stack_type(self, cutoff=1.0):</span>
    <span class="c1">#     if self.oangle &lt; 30.0 * cutoff:</span>
    <span class="c1">#         return &#39;face_to_face&#39;</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         return &#39;face_to_edge&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mindist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: minimum dist between sites on different bones</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distmat</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">distmat</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minbonedist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: minimum dist between sites on different bones</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distmat</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">cart_coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">distmat</span><span class="p">)</span>

<div class="viewcode-block" id="ConformerDimer.plt_bone_overlap"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer.plt_bone_overlap">[docs]</a>    <span class="k">def</span> <span class="nf">plt_bone_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s1">&#39;convex&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;bone_overlap.eps&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot a 2d graph of how backbones overlap</span>

<span class="sd">        using concave or convex hull</span>

<span class="sd">        :param algo: concave/convex</span>
<span class="sd">        :param output: output filename</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref_bone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span>

        <span class="n">ref_p</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vp&#39;</span><span class="p">]</span>
        <span class="n">ref_q</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vq&#39;</span><span class="p">]</span>
        <span class="n">ref_o</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vo&#39;</span><span class="p">]</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">geoc</span>

        <span class="n">ref_proj_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_proj_point2plane</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>
        <span class="n">var_proj_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_proj_point2plane</span><span class="p">(</span><span class="n">vs</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>

        <span class="c1"># convert to 2d points on the plane</span>
        <span class="n">ref_2dpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord_transform</span><span class="p">(</span><span class="n">ref_p</span><span class="p">,</span> <span class="n">ref_q</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">p3d</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p3d</span> <span class="ow">in</span> <span class="n">ref_proj_pts</span><span class="p">]</span>
        <span class="n">var_2dpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord_transform</span><span class="p">(</span><span class="n">ref_p</span><span class="p">,</span> <span class="n">ref_q</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">p3d</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p3d</span> <span class="ow">in</span> <span class="n">var_proj_pts</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;concave&#39;</span><span class="p">:</span>
            <span class="n">ref_hull</span><span class="p">,</span> <span class="n">ref_edge_points</span> <span class="o">=</span> <span class="n">alpha_shape</span><span class="p">(</span><span class="n">ref_2dpts</span><span class="p">)</span>
            <span class="n">var_hull</span><span class="p">,</span> <span class="n">var_edge_points</span> <span class="o">=</span> <span class="n">alpha_shape</span><span class="p">(</span><span class="n">var_2dpts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;convex&#39;</span><span class="p">:</span>
            <span class="n">ref_hull</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">ref_2dpts</span><span class="p">)</span><span class="o">.</span><span class="n">convex_hull</span>
            <span class="n">var_hull</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">var_2dpts</span><span class="p">)</span><span class="o">.</span><span class="n">convex_hull</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;bone_overlap receive a wrong algo spec&#39;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">var_hull</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">polygon_shape</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon_shape</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ref_hull</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">polygon_shape</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon_shape</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConformerDimer.mol_overlap"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer.mol_overlap">[docs]</a>    <span class="k">def</span> <span class="nf">mol_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s1">&#39;concave&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        project var mol onto the plane of ref mol</span>

<span class="sd">        :param algo: concave/convex</span>
<span class="sd">        :return: area of the overlap, ref omol area, var omol area</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref_bone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span>

        <span class="n">ref_p</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vp&#39;</span><span class="p">]</span>
        <span class="n">ref_q</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vq&#39;</span><span class="p">]</span>
        <span class="n">ref_o</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vo&#39;</span><span class="p">]</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">geoc</span>

        <span class="n">ref_proj_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_proj_point2plane</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>
        <span class="n">var_proj_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_proj_point2plane</span><span class="p">(</span><span class="n">vs</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>

        <span class="c1"># convert to 2d points on the plane</span>
        <span class="n">ref_2dpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord_transform</span><span class="p">(</span><span class="n">ref_p</span><span class="p">,</span> <span class="n">ref_q</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">p3d</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p3d</span> <span class="ow">in</span> <span class="n">ref_proj_pts</span><span class="p">]</span>
        <span class="n">var_2dpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord_transform</span><span class="p">(</span><span class="n">ref_p</span><span class="p">,</span> <span class="n">ref_q</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">p3d</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p3d</span> <span class="ow">in</span> <span class="n">var_proj_pts</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;concave&#39;</span><span class="p">:</span>
            <span class="n">ref_hull</span><span class="p">,</span> <span class="n">ref_edge_points</span> <span class="o">=</span> <span class="n">alpha_shape</span><span class="p">(</span><span class="n">ref_2dpts</span><span class="p">)</span>
            <span class="n">var_hull</span><span class="p">,</span> <span class="n">var_edge_points</span> <span class="o">=</span> <span class="n">alpha_shape</span><span class="p">(</span><span class="n">var_2dpts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;convex&#39;</span><span class="p">:</span>
            <span class="n">ref_hull</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">ref_2dpts</span><span class="p">)</span><span class="o">.</span><span class="n">convex_hull</span>
            <span class="n">var_hull</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">var_2dpts</span><span class="p">)</span><span class="o">.</span><span class="n">convex_hull</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;overlap receive a wrong algo spec&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ref_hull</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">var_hull</span><span class="p">)</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">ref_hull</span><span class="o">.</span><span class="n">area</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">var_hull</span><span class="o">.</span><span class="n">area</span><span class="p">))</span></div>

<div class="viewcode-block" id="ConformerDimer.bone_overlap"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.ConformerDimer.bone_overlap">[docs]</a>    <span class="k">def</span> <span class="nf">bone_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s1">&#39;concave&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        project var backbone onto the plane of ref backbone</span>
<span class="sd">        as there&#39;s the problem of alpha value in concave hull generation, maybe I should set default to convex, see hull_test</span>

<span class="sd">        :param algo: concave/convex</span>
<span class="sd">        :return: area of the overlap, ref omol area, var omol area</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref_bone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span>

        <span class="n">ref_p</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vp&#39;</span><span class="p">]</span>
        <span class="n">ref_q</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vq&#39;</span><span class="p">]</span>
        <span class="n">ref_o</span> <span class="o">=</span> <span class="n">ref_bone</span><span class="o">.</span><span class="n">conformer_properties</span><span class="p">[</span><span class="s1">&#39;pfit_vo&#39;</span><span class="p">]</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">geoc</span>

        <span class="n">ref_proj_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_proj_point2plane</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>
        <span class="n">var_proj_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_proj_point2plane</span><span class="p">(</span><span class="n">vs</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>

        <span class="c1"># convert to 2d points on the plane</span>
        <span class="n">ref_2dpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord_transform</span><span class="p">(</span><span class="n">ref_p</span><span class="p">,</span> <span class="n">ref_q</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">p3d</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p3d</span> <span class="ow">in</span> <span class="n">ref_proj_pts</span><span class="p">]</span>
        <span class="n">var_2dpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord_transform</span><span class="p">(</span><span class="n">ref_p</span><span class="p">,</span> <span class="n">ref_q</span><span class="p">,</span> <span class="n">ref_o</span><span class="p">,</span> <span class="n">p3d</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p3d</span> <span class="ow">in</span> <span class="n">var_proj_pts</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;concave&#39;</span><span class="p">:</span>
            <span class="n">ref_hull</span><span class="p">,</span> <span class="n">ref_edge_points</span> <span class="o">=</span> <span class="n">alpha_shape</span><span class="p">(</span><span class="n">ref_2dpts</span><span class="p">)</span>
            <span class="n">var_hull</span><span class="p">,</span> <span class="n">var_edge_points</span> <span class="o">=</span> <span class="n">alpha_shape</span><span class="p">(</span><span class="n">var_2dpts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algo</span> <span class="o">==</span> <span class="s1">&#39;convex&#39;</span><span class="p">:</span>
            <span class="n">ref_hull</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">ref_2dpts</span><span class="p">)</span><span class="o">.</span><span class="n">convex_hull</span>
            <span class="n">var_hull</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">var_2dpts</span><span class="p">)</span><span class="o">.</span><span class="n">convex_hull</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;overlap receive a wrong algo spec&#39;</span><span class="p">)</span>

        <span class="n">mindist2d</span> <span class="o">=</span> <span class="n">ref_hull</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">var_hull</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">ref_hull</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">var_hull</span><span class="p">)</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">ref_hull</span><span class="o">.</span><span class="n">area</span><span class="p">),</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">var_hull</span><span class="o">.</span><span class="n">area</span><span class="p">),</span>
                <span class="n">mindist2d</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">sites</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">sites</span></div>


<div class="viewcode-block" id="DimerCollection"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.DimerCollection">[docs]</a><span class="k">class</span> <span class="nc">DimerCollection</span><span class="p">:</span>
<div class="viewcode-block" id="DimerCollection.__init__"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.DimerCollection.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimers</span><span class="p">:</span> <span class="p">[</span><span class="n">ConformerDimer</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        just a list of dimers, they should share the same ref_mol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimers</span> <span class="o">=</span> <span class="n">dimers</span></div>

<div class="viewcode-block" id="DimerCollection.get_xyz_string"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.DimerCollection.get_xyz_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_xyz_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lalabel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: xyz string to be written</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">d</span><span class="p">:</span> <span class="n">ConformerDimer</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimers</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="n">conformer_var</span><span class="o">.</span><span class="n">sites</span>
        <span class="k">if</span> <span class="n">lalabel</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Site</span><span class="p">(</span><span class="s1">&#39;La&#39;</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">ss</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_ref</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_sites</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">XYZ</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span></div>

<div class="viewcode-block" id="DimerCollection.to_xyz"><a class="viewcode-back" href="../../../ocelot.schema.html#ocelot.schema.conformer.DimerCollection.to_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">to_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">lalabel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param lalabel:</span>
<span class="sd">        :param fn: xyz file name, with extension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xyz_string</span><span class="p">(</span><span class="n">lalabel</span><span class="p">))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Ai, Qianxiang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>